(function(d){var b=d.requires("BaseControl"),f=d.requires("jquery"),c=d.requires("underscore"),a;
var e=b.extend(function(g){var n={CLOSED:0,OPEN:1},h={DOWN:40,UP:38,ENTER:13,ESC:27},o={UP:"up",DOWN:"down",ENTER:"enter",KEYPRESS:"keypress"},k={CONTROLS:"aria-controls",SELECT:"combobox",LISTBOX:"listbox",OPTION:"option",LEVEL:"aria-level",HIDDEN:"aria-hidden",ACTIVEDESCENDANT:"aria-activedescendant",EXPANDED:"aria-expanded",SELECTED:"aria-selected",VALUENOW:"aria-valuenow",ROLE:"role",HASPOPUP:"haspopup"},i={TRUE:"true",FALSE:"false",LI:"li"},j=300,l={CLICK:"click",MOUSEENTER:"mouseenter",MOUSELEAVE:"mouseleave",FOCUS:"focus",BLUR:"blur"},m={dependencies:["scripts/shared/KeyEvents"],styledListSelector:null,selectionStateField:null,CLASSES:{OPEN:"open",HIGHLIGHTED:"highlighted",SELECTED:"selected"},NAMESPACE:"AccessibleStyledDropdown"};
return{beforeDecoration:function(){this._config=c.defaults(this._config,m);
this._state=n.CLOSED;
this._baseId=this._$el.get(0).id||this._createUniqueId();
this._$el.attr("id",this._baseId);
this._onBodyClick=c.bind(this._onBodyClick,this);
this._onListClick=c.bind(this._onListClick,this);
this._$body=f(document.body);
if(!this._$el.data("li-styled-list")&&!this._config.styledListSelector){throw"Styled list selector must be set."
}if(!this._config.styledListSelector){this._$styledList=f(this._$el.data("li-styled-list"))
}else{this._$styledList=f(this._config.styledListSelector)
}this._$styledListLis=this._$styledList.children(i.LI);
this._numberOfOptions=this._$styledListLis.size();
for(var p=0;
p<this._numberOfOptions;
p++){this._$styledListLis[p].id=this._baseId+"-option-"+p
}this._currentlySelectedIndex=this._$styledList.find("."+this._config.CLASSES.SELECTED).index()||0;
this._currentlySelectedIndex=this._currentlySelectedIndex>-1?this._currentlySelectedIndex:0;
this._currentlyHighlightedIndex=this._currentlySelectedIndex;
this._suggestedText="";
this._options=c.map(this._$styledList.children(i.LI),function(q){return f(q).text().toLowerCase().replace(/[\-#$\^*()+\[\]{}|\\,.?\s]/g,"\\$&")
});
this._$selectedLi=this._$styledListLis.eq(this._currentlySelectedIndex);
this._$highlightedLi=this._$selectedLi;
this._$stateField=f(this._config.selectionStateField);
this.highlightByIndex(this._currentlySelectedIndex);
this._ariaBootstrap()
},afterLoad:function(){a=d.requires("keyEvents");
a._config.decorators=["scripts/shared/KeyEvents/KeyPress"];
return a.decorate().then(function(){a.initKeyPress()
})
},attachEventListeners:function(){this._$el.on(l.CLICK,c.bind(this._onTargetClick,this));
this._$el.on(l.FOCUS,c.bind(this._onTargetFocus,this));
this._$el.on(l.BLUR,c.bind(this._onTargetBlur,this))
},open:function(){this._state=n.OPEN;
this._setShowingHandlers();
this._toggleStyledList(this._state)
},close:function(){this._state=n.CLOSED;
this._removeShowingHandlers();
this._toggleStyledList(this._state)
},highlightNextItem:function(){if(this._currentlyHighlightedIndex===(this._numberOfOptions-1)){this._currentlyHighlightedIndex=0
}else{this._currentlyHighlightedIndex+=1
}this.highlightByIndex(this._currentlyHighlightedIndex)
},highlightPrevItem:function(){if(this._currentlyHighlightedIndex===0){this._currentlyHighlightedIndex=this._numberOfOptions-1
}else{this._currentlyHighlightedIndex-=1
}this.highlightByIndex(this._currentlyHighlightedIndex)
},highlightByIndex:function(r){var p;
if(r<0){return
}var q=this._config.CLASSES.HIGHLIGHTED;
this._currentlyHighlightedIndex=r;
this._$highlightedLi.removeClass(q);
this._$highlightedLi=this._$styledListLis.eq(this._currentlyHighlightedIndex).addClass(q);
p=this._$highlightedLi.attr("id");
this._$el.attr(k.ACTIVEDESCENDANT,p);
if(this._state===n.CLOSED){this.selectByIndex(this._currentlyHighlightedIndex)
}},selectByIndex:function(q){var p=this._config.CLASSES.SELECTED,r;
this._currentlySelectedIndex=q;
this._currentlyHighlightedIndex=this._currentlySelectedIndex;
this._$selectedLi.removeClass(p);
this._$selectedLi.attr(k.SELECTED,i.FALSE);
this._$selectedLi=this._$styledListLis.eq(this._currentlySelectedIndex).addClass(p);
r=this._$selectedLi.text();
this._$stateField.text(r);
this._$el.attr(k.VALUENOW,r);
this._$selectedLi.attr(k.SELECTED,i.TRUE);
this.optionSelected(this._$styledListLis.eq(q),q);
if(this._state===n.OPEN){this.close()
}},selectHighlightedItem:function(){this.selectByIndex(this._currentlyHighlightedIndex)
},queryFromKeypress:function(q){this._suggestedText+=q;
var p=this.indexFromQuery(this._suggestedText);
if(p<0){p=this.nextIndexFromCharacter(q,this._currentlyHighlightedIndex)
}this.highlightByIndex(p);
this._lastChar=q;
this._keydownTimeout();
return p
},indexFromQuery:function(t){var r=this._options,q,s,p;
for(s=0,p=r.length;
s<p;
s++){if(r[s].indexOf(t)===0){return s
}}return -1
},nextIndexFromCharacter:function(t,u){if(this._lastChar===t){var q=this._options,s=u+1,r=s,p=q.length;
for(;
s<p;
s++){if(q[s].indexOf(t)===0){return s
}}for(s=0;
s<r;
s++){if(q[s].indexOf(t)===0){return s
}}return -1
}return -1
},optionSelected:function(p,q){},_createUniqueId:function(){var p=this._config.NAMESPACE+"_"+c.uniqueId();
this._$el.attr("id",p);
return p
},_ariaBootstrap:function(){this._$el.attr(k.CONTROLS,this._$styledList.attr("id")).attr(k.ROLE,k.SELECT).attr(k.HASPOPUP,i.TRUE);
this._$styledList.attr(k.LEVEL,"2").attr(k.ROLE,k.LISTBOX);
this._$selectedLi.attr(k.SELECTED,i.TRUE);
this._$styledListLis.attr(k.ROLE,k.OPTION)
},_onTargetClick:function(p){var q;
q=c.clone(p);
p.preventDefault();
p.stopPropagation();
if(this._state===n.OPEN){this.close()
}else{this.open();
this._$el.parent().trigger(q,this)
}},_onTargetFocus:function(p){p.stopPropagation();
var q="#"+this._$el.get(0).id;
a.on(q,o.KEYPRESS,this._onKeypress,this);
a.on(q,o.UP,this._onKeydown,this);
a.on(q,o.DOWN,this._onKeydown,this);
a.on(q,o.ENTER,this._onKeydown,this)
},_onTargetBlur:function(p){p.stopPropagation();
var q="#"+this._$el.get(0).id;
a.off(q,o.KEYPRESS,this._onKeypress,this);
a.off(q,o.UP,this._onKeydown,this);
a.off(q,o.DOWN,this._onKeydown,this);
a.off(q,o.ENTER,this._onKeydown,this)
},_onKeydown:function(r,q){var p=q.which;
if(p===h.ENTER){q.preventDefault();
if(this._state===n.CLOSED){this.open()
}else{this.selectHighlightedItem()
}}else{if(p===h.DOWN){q.preventDefault();
this.highlightNextItem()
}else{if(p===h.UP){q.preventDefault();
this.highlightPrevItem()
}else{if(p===h.ESCAPE){q.preventDefault();
this.close()
}}}}if(this._state===n.CLOSED){this.selectByIndex(this._currentlyHighlightedIndex)
}},_onKeypress:function(q,p){var r=String.fromCharCode(p.which);
this.queryFromKeypress(r)
},_onBodyClick:function(q,p){if(this._state===n.OPEN&&p!==this){this.close()
}},_toggleStyledList:function(q){var p=this._$highlightedLi.attr("id");
if(q>0){this._$styledList.addClass(this._config.CLASSES.OPEN);
this._$styledList.attr(k.HIDDEN,i.FALSE);
this._$el.attr(k.ACTIVEDESCENDANT,p);
this._$el.attr(k.EXPANDED,i.TRUE);
this._$selectedLi.addClass(this._config.CLASSES.HIGHLIGHTED)
}else{this._$styledList.removeClass(this._config.CLASSES.OPEN);
this._$styledList.attr(k.HIDDEN,i.TRUE);
this._$el.attr(k.EXPANDED,i.FALSE)
}},_setShowingHandlers:function(){this._$body.on(l.CLICK,this._onBodyClick);
this._$styledList.on(l.MOUSEENTER,i.LI,this._onListMouseenter).on(l.MOUSELEAVE,i.LI,this._onListMouseleave).on(l.CLICK,i.LI,this._onListClick)
},_removeShowingHandlers:function(){this._$body.off(l.CLICK,this._onBodyClick);
this._$styledList.off(l.MOUSEENTER,i.LI,this._onListMouseenter).off(l.MOUSELEAVE,i.LI,this._onListMouseleave).off(l.CLICK,i.LI,this._onListClick)
},_onListMouseenter:function(p){var q=this._config.CLASSES.HIGHLIGHTED;
this._$styledListLis.removeClass(q);
f(p.target).addClass(q)
},_onListMouseleave:function(p){f(p.target).removeClass(this._config.CLASSES.HIGHLIGHTED)
},_onListClick:function(p){this.selectByIndex(f(p.target).index());
this.close()
},_keydownTimeout:function(){if(this._anTimeout){clearTimeout(this._anTimeout)
}this._anTimeout=setTimeout(c.bind(function(){this._suggestedText="";
this._lastChar=null
},this),j)
}}
});
d.exports("AccessibleStyledDropdown",e)
}(LIModules));(function(c){var a="spinner",b=c.requires("jquery");
function d(){return b('<div class="'+a+'"></div>')
}c.exports("Spinner",{showSpinner:function(e){var f=e.children("."+a);
if(f.length===0){e.append(d()).children("."+a).height(e.prop("scrollHeight"))
}else{e.children("."+a).show().height(e.prop("scrollHeight"))
}},hideSpinner:function(e){e.children("."+a).hide()
}})
}(window.LIModules));(function(c){var f=window.jQuery||c("jquery"),b=LIModules.imports("BaseControl"),a=LIModules.imports("Events"),h=LIModules.imports("parseQueryString"),e,d;
var g=b.extend(function(j){var v,l,u,i,r,s,p,k,n,m,o,q,t;
r={pub:{PREVENT_ACTION_SEL:".signup-button"},cxn1:{PREVENT_ACTION_SEL:[".endorse-button",".profile-actions.view-actions",".endorse-user a",".groups-join",".select-follow-action",".social-container .comment-btn",".social-container .actions"].join(",")},EXCEPTION_SELECTOR:".always-allow",NAV_HEIGHT:42,NAV_WITH_SUBNAV_HEIGHT:71};
return{beforeDecoration:function(){v=this;
u=this._config.currentCtx;
if(this._config.adContainerId){t={$el:f(this._config.adContainerId)};
t.height=t.$el.outerHeight()
}if(r[u]){s=r[u].PREVENT_ACTION_SEL
}v._initCtxBanner();
v._initDropDown()
},attachEventListeners:function(){var w="globalnav:show globalnav:hide globalnav:hideStart globalnav:showStop";
if(t){w+=" globalnav:showStart"
}a.bind(w,v._repositionBanner);
if(s){if(document.addEventListener){f("body").get(0).addEventListener("click",function(y){var x=f(y.target);
if(x.closest(s).length&&!x.closest(r.EXCEPTION_SELECTOR).length){y.preventDefault();
y.stopImmediatePropagation();
v._openActionDisabledDlg()
}},true)
}}},_initCtxBanner:function(){q=f("html").is(".os-ios, .ios-android");
l=f("#preview-ctx");
if(f("#responsive-nav-scrollable").css("position")==="fixed"){v._repositionBanner({name:"globalnav:hide"})
}if(t){v._repositionBannerWithAd()
}l.insertAfter(f("#header"))
},_repositionBanner:function(w){if(l&&l.length&&!q){if(!t){l.css("top",(w.name==="globalnav:show"||w.name==="globalnav:showStop")?r.NAV_WITH_SUBNAV_HEIGHT+"px":r.NAV_HEIGHT+"px");
return
}v._repositionBannerWithAd();
v._bindScrollEvent()
}},_repositionBannerWithAd:function(){var A=f("#responsive-nav-scrollable").css("position")==="fixed",w=A?r.NAV_HEIGHT:r.NAV_WITH_SUBNAV_HEIGHT,y=Math.max(0,f(window).scrollTop()),z=t.height-y,x=(z>w)?z:w;
l.css("top",x+"px");
if(x===r.NAV_HEIGHT||x===t.height){v._unbindScrollEvent()
}},_unbindScrollEvent:function(){f(window).off("scroll",v._repositionBannerWithAd)
},_bindScrollEvent:function(){v._unbindScrollEvent();
f(window).on("scroll",v._repositionBannerWithAd)
},_initDropDown:function(){var w=f("#ctx-dropdown-target"),y,x;
if(u){x=l.find("#"+u+"-opt");
x.addClass("selected");
i=x.parent().children().index(x)
}if(!e){e=LIModules.imports("AccessibleStyledDropdown")
}y=new e(w,{selectionStateField:"#ctx-dropdown-state"});
y.clobber("optionSelected",v._optionSelected)
},_optionSelected:function(x,A){var w=x.data("href"),y=x.data("ppv"),z=h(w);
if((u==="you"&&!z.vpa)||(u===z.vpa)){return
}else{if(z.vpa==="pub"&&!y){v._openPublicProfileDisabledDlg();
this.selectByIndex(i)
}else{window.location=w
}}},_openActionDisabledDlg:function(){var w=LIModules.imports("ModalDialogBox");
if(!p){p=new w(f(),{width:460,title:v._config.actionDisabledDlgTitle,decorators:["scripts/shared/Dialog/AjaxDustLoading"],dependencies:["scripts/shared/Spinner"],dustContentTemplate:"tl/apps/profile/preview_profile/action_disabled_dialog",templateDataUrl:v._config.actionDisabledUrl,dataContextPath:"content"});
p.clobber("_loadContent",v._loadNoActionDlgContent)
}p.isReady.then(function(){v._trackActivity("prof-preview-modal-action_disabled");
p.open()
})
},_loadNoActionDlgContent:function(){var w=this;
if(!m){if(!d){d=LIModules.imports("Spinner")
}d.showSpinner(p._$dialog.find(".dialog-body"))
}return f.when(this.loadDependencies([p._config.dustContentTemplate]),w._getNoActionDlgContent(),this.loadCss(["css!scss/apps/profile/v2/preview_profile/disabled_dialog"]))
},_getNoActionDlgContent:function(){var w=this._config.locale;
if(m){return m
}return f.ajax({url:p._href,success:function(x){x.content.url_edit=LI.addParams(x.content.url_edit,{"locale":w});
m=f.Deferred().resolve([x]);
return x
}})
},_openPublicProfileDisabledDlg:function(){var w=LIModules.imports("ModalDialogBox");
if(!k){k=new w(f(),{width:500,title:v._config.publicProfileDisabledDlgTitle,decorators:["scripts/shared/Dialog/AjaxDustLoading"],dependencies:["scripts/shared/Spinner"],dustContentTemplate:"tl/apps/profile/preview_profile/public_profile_disabled_dialog",templateDataUrl:v._config.publicProfileDisabledUrl,dataContextPath:"content"});
k.clobber("_loadContent",v._loadPublicProfileDisabledDlgContent)
}k.isReady.then(function(){v._trackActivity("prof-preview-modal-public_profile_disabled");
k.open()
})
},_loadPublicProfileDisabledDlgContent:function(){var w=this;
if(!o){if(!d){d=LIModules.imports("Spinner")
}d.showSpinner(k._$dialog.find(".dialog-body"))
}return f.when(this.loadDependencies([k._config.dustContentTemplate]),w._getPublicProfileDisabledDlgContent(),this.loadCss(["css!scss/apps/profile/v2/preview_profile/disabled_dialog"]))
},_getPublicProfileDisabledDlgContent:function(){if(o){return o
}return f.ajax({url:k._href,success:function(w){o=f.Deferred().resolve([w]);
return w
}})
},_trackActivity:function(w){if(window.WebTracking&&w){WebTracking.trackUserAction(w)
}}}
});
LIModules.exports("ContextBanner",g)
}(window.require));(function(){var f=window.jQuery||require("jquery"),i=window._||require("underscore"),c=window.dust||require("dust"),d=LIModules.imports("BaseControl"),h=LIModules.imports("BalloonCallout"),a=LIModules.imports("injectAlert"),e=LIModules.imports("parseQueryString"),j=LIModules.requires("Events"),b={SAVE_SUCCESS:"FREEMIUM_SAVE_SUCCESS",REMOVE_SUCCESS:"FREEMIUM_REMOVE_SUCCESS"};
var g=d.extend(function(t){var w="src",y="freemium-bg",B="edit-my-profile",D=974,k,p=1048576,x=p*6,r=1260,m=383,A={templateId:"tl/apps/profile/v2/embed/freemium_profile"},z={UPLOAD_TIME:"TIME",UPLOAD_SIZE:"SIZE",UPLOAD_INV_MEDIA:"INV_MEDIA",UPLOAD_DIMENSION:"DIMENSION",UPLOAD_500:"RESP_500",MUTATOR:"MUTATOR",NULL_MEDIA:"NULL_MEDIA",TIME_RETRY:"TIME_RETRY"},v={ERROR:"error",WARNING:"warning"},s={LOADING:"loading",VIEW:"view",EDIT:"edit",EDIT_VERTICAL:"edit-vertical",UPLOAD:"upload",EDIT_IMAGE:"edit-image"},C={UPLOADER_DISABLED:"disabled",UPLOADER_HOVER:"hover-mode",UPLOADER_INPUT:".freemium-bg-upload-input"},l={CLICK:"click",CHANGE:"change",MOUSEUP:"mouseup",MOUSEDOWN:"mousedown",MOUSEMOVE:"mousemove",LOAD:"load",SCROLL:"scroll",SUBMIT:"submit",UPLOAD_SUCCESS:"mpr-upload-success",UPLOAD_ERROR:"mpr-upload-error"},u={prefixEdit:"profile_edit_",prefixView:"profile_view_",events:{BG_IMPRESSION:"custom_bg_impr",BG_BROWSE:"custom_bg_browse",INFO_BUBBLE:"custom_bg_info",IMAGE_SELECTED:"custom_bg_open",IMAGE_CANCELED:"custom_bg_cancel",UPLOAD_FAIL:"custom_bg_fail",IMAGE_SAVE:"custom_bg_save",IMAGE_CHANGE:"custom_bg_change",IMAGE_REMOVE:"custom_bg_remove",BG_EDIT:"custom_bg_edit",IMAGE_FAIL:"image_load_fail",UPLOAD_SUCCESS:"photo_upload_success",SAVE_SUCCESS:"photo_save_success"}},n=["#ad-slot-3","#text-ad-container",".textad"],E=["#preview-ctx"],q={INPUT:"input"},o=LIModules.imports("MediaServerUploader");
return{beforeLoad:function(){if(!o&&this._config.selfView){this._config.dependencies=["scripts/shared/MediaServerUploader"]
}},afterLoad:function(){this._useDefaultsIfNeeded();
this._renderModule()
},setImage:function(F){if(F.url!==this._currentImage.url){if((this._config.originalIsCustomUpload||this._config.isCustomUpload)&&F.url.indexOf(".jpg")!==-1){this._currentImage.url=F.url;
this._$image.attr(w,this._currentImage.url).show()
}else{this._$image.hide()
}}},_preloadImage:function(H){var I=f.Deferred(),F=new Image(),G=this;
F.onerror=function(){G._track(u.events.IMAGE_FAIL,{imageUrl:H});
I.resolve(null)
};
F.onload=function(){I.resolve(F)
};
F.src=H;
return I.promise()
},setPosition:function(F){if(F.offsetY>0){F.offsetY=0
}this._setMaxOffset();
if(F.offsetY<this._maxOffset){F.offsetY=this._maxOffset
}if(F.offsetY!==this._currentImage.offsetY){this._currentImage.offsetY=F.offsetY;
this._$image.css("top",this._currentImage.offsetY)
}},_useDefaultsIfNeeded:function(){k=this._config.templateId||A.templateId
},_renderModule:function(){var G=this,F=function(I,H){if(I){return
}G._$body=f("body").prepend(H);
G._initModule()
};
if(this._config.selfView){f.get(this._config.dataUrl).then(function(H){if(!H.content){return
}G._content=H.content.TopcardBackground;
G._content.csrfToken=e(G._config.saveUrl).csrfToken;
i.extend(G._content,G._config.i18n);
c.render(k,G._content,F)
},function(){G._showError()
})
}else{f(function(){c.render(k,G._config,F)
})
}},_initModule:function(){this._originalMediaId=this._mediaId=this._config.mediaId;
this._originalOffsetY=-this._config.imageData.offsetY;
this._config.originalIsCustomUpload=this._config.isCustomUpload;
this._currentImage={};
this._mediaIdSignature=null;
this._cacheNodes();
this._attachEventListeners();
this._imageLoader=null;
this._canUpload=true;
if(this._config.selfView){this._initUploader()
}this._resetModule()
},_cacheNodes:function(){this._$win=f(window);
this._$doc=f(document);
this._$wrap=f("#wrapper");
this._$el=f("#freemium-bg");
this._$image=this._$el.find(".freemium-bg-image");
this._$textAd=f(n.join(","));
this._$hiddenOnEditElements=this._$textAd.add(E.join());
this._$header=f("#header");
this._$responsiveNav=f("#responsive-nav-scrollable");
if(this._config.isCustomUpload){this._$body.addClass(y)
}else{if(this._config.selfView&&this._config.uploadOnView){this._$body.addClass(y)
}}if(this._config.selfView){this._$profile=f("#body > .wrapper");
this._$uploadForm=this._$el.find(".freemium-bg-upload-form");
this._$uploadInput=this._$el.find(C.UPLOADER_INPUT);
this._$uploadClone=this._$uploadInput.clone();
this._$saveButton=this._$el.find(".freemium-bg-save-button");
this._$cancelButton=this._$el.find(".freemium-bg-cancel-button");
this._$removeButton=this._$el.find(".remove-image");
this._$editButton=this._$el.find(".freemium-bg-edit-button");
this._$changeArea=this._$el.find(".freemium-bg-change-button");
this._$drag=this._$el.find(".freemium-bg-drag-prompt")
}},_attachEventListeners:function(){this._$win.on(l.SCROLL,this._onWindowScroll);
if(this._config.selfView){this._$el.on(l.CLICK,C.UPLOADER_INPUT,this._uploadClick).on(l.CHANGE,C.UPLOADER_INPUT,this._uploadImage);
this._$saveButton.on(l.CLICK,this._saveImage);
this._$cancelButton.on(l.CLICK,this._resetModule);
this._$removeButton.on(l.CLICK,this._removeImage);
this._$editButton.on(l.CLICK,this._editBgClick);
this._$uploadForm.on(l.UPLOAD_ERROR,this._onUploadError).on(l.UPLOAD_SUCCESS,this._onUploadSuccess);
this._$doc.on(l.MOUSEDOWN,this._onBackgroundMouseDown);
this._$win.on("resize",this._setScalingDimension);
this._bindProfileEvents()
}},_bindProfileEvents:function(){if(i.has(f.fn,"Profile")){f.fn.Profile.bind(f.fn.Profile.EVENTS.SWITCH_EDIT,this._onProfileEdit);
f.fn.Profile.bind(f.fn.Profile.EVENTS.SWITCH_VIEW,this._onProfileView)
}else{setTimeout(i.bind(this._bindProfileEvents,this),25)
}},_initUploader:function(){if(!o){o=LIModules.imports("MediaServerUploader")
}this._uploader=new o(this._$uploadForm[0])
},_uploadClick:function(F){this._track(u.events.BG_BROWSE)
},_editBgClick:function(F){this._track(u.events.BG_EDIT);
this._setState(s.EDIT);
this._enableChangeBgUploader();
this._$hiddenOnEditElements.hide()
},_uploadImage:function(I){var G,H,K=f(I.currentTarget),J=K.val(),F;
if(J){H=J.substring(J.lastIndexOf(".")+1).toLowerCase();
switch(H){case"gif":case"jpg":case"jpeg":case"png":break;
default:this._showError(this._config.errors.media);
this._track(u.events.UPLOAD_FAIL,{failureType:z.UPLOAD_INV_MEDIA});
return
}if(window.File&&window.FileList){G=I.target.files[0];
F=Math.max((this._config.maxUploadSizeInMB||0)*p,x);
if(G.size>F){this._showError(this._config.errors.size);
this._track(u.events.UPLOAD_FAIL,{failureType:z.UPLOAD_SIZE});
return
}}this._setState(s.LOADING);
this._$uploadForm.trigger(l.SUBMIT);
this._track(u.events.IMAGE_SELECTED)
}else{this._track(u.events.IMAGE_CANCELED)
}},_setMaxOffset:function(){var F=this._$image.height(),H=this._$image.width(),G=this._$el.height(),I=this._config.selfView;
this._maxOffset=G-F;
if(this._maxOffset>=0){this._maxOffset=0;
if(I){this._$drag.css("display","none")
}}else{if(I){this._$drag.css("display","")
}}},_setScalingDimension:function(I){if(null!==I){var M=i.has(I,"width")?I:this._$image[0],F=M.height,G=this._$el.height(),H=M.width,K=this._$el.width(),J=F/H,L=G/K;
if(J<L){this._$image.addClass("freemium-bg-scale-height")
}else{if(H<K){this._$image.removeClass("freemium-bg-scale-height")
}}if(this._state===s.EDIT){this._enableChangeBgUploader()
}this._setMaxOffset();
if(this._$image.position().top<this._maxOffset){this.setPosition({offsetY:this._maxOffset})
}}},_checkImageSize:function(H){var F=H.width<r,G=H.height<m;
if(F||G){a({message:this._config.i18n.i18n_recommended_size,type:v.WARNING,dismissable:true,animate:true})
}},_removeImage:function(F){this._track(u.events.IMAGE_REMOVE);
this._syncBackgroundSettings(true)
},_saveImage:function(F){this._track(u.events.IMAGE_SAVE);
this._syncBackgroundSettings()
},_syncBackgroundSettings:function(F){var G=this,I=(true===F),H=!I,J=function(K){if(K.status==="fail"){G._showError();
G._track(u.events.UPLOAD_FAIL,{failureType:z.MUTATOR});
G._setState(s.EDIT)
}else{G._setState(s.EDIT_IMAGE);
G._originalMediaId=H?G._mediaId:"";
G._originalOffsetY=H?Math.round(G._currentImage.offsetY):0;
G._config.isCustomUpload=H;
G._config.originalIsCustomUpload=H;
G._disableBgUploader();
G._track(u.events.SAVE_SUCCESS);
j.trigger(I?b.REMOVE_SUCCESS:b.SAVE_SUCCESS);
if(!H){G._resetModule()
}}};
if(!H&&!G._config.originalIsCustomUpload){J({status:"okay"})
}else{if(!this._mediaId){this._track(u.events.UPLOAD_FAIL,{failureType:z.NULL_MEDIA});
this._showError()
}else{this._setState(s.LOADING);
if(!H){G._mediaId=G._config.imageData.defaultImage;
G._currentImage.offsetY=0
}f.get(G._config.dataUrl).then(function(K){G._content.timestamp=K.content.TopcardBackground.timestamp;
G._content.profileVersionTag=K.content.TopcardBackground.profileVersionTag;
G._content.privacySettingsVersionTag=K.content.TopcardBackground.privacySettingsVersionTag
}).then(function(){f.ajax(G._config.saveUrl,{type:"POST",headers:{"X-IsAJAXForm":1},data:{bgEnabled:H,mediaID:H?G._mediaId:"",signature:H?G._mediaIdSignature:null,isCustomImage:H,yPos:G._currentImage.offsetY?Math.round(-G._currentImage.offsetY):0,timestamp:G._content.timestamp,changeCount:G._content.changeCount,locale:G._content.locale,profileVersionTag:G._content.profileVersionTag,privacySettingsVersionTag:G._content.privacySettingsVersionTag}}).then(J)
})
}}},_showError:function(F){a({message:F||this._config.errors.defaultErr,type:v.ERROR,dismissable:true,animate:true})
},_resetModule:function(){var F=this,G=this._getMediaUrl(this._originalMediaId),H,I;
this._$hiddenOnEditElements.show();
this._config.isCustomUpload=this._config.originalIsCustomUpload;
if(this._config.selfView){H=this._isInEditMode();
I=(H||this._displayUploadOnView())&&this._config.showUploader;
if(I){this._onProfileEdit();
this._disableBgUploader();
if(this._config.isCustomUpload){this._setState(s.EDIT_IMAGE)
}else{this._setState(s.UPLOAD);
this._enableAddBgUploader()
}}else{this._onProfileView()
}}if(this._config.originalIsCustomUpload){this._preloadImage(G).then(function(J){F._setScalingDimension(J);
F.setImage({url:G});
F.setPosition({offsetY:F._originalOffsetY})
})
}},_onUploadError:function(H,I){var G,J={failureType:I.error||"generic",uploadedFilename:this._getUploadedFileName()},F=this;
switch(I.error){case z.UPLOAD_SIZE:G=this._config.errors.size;
break;
case z.UPLOAD_INV_MEDIA:G=this._config.errors.media;
break;
case z.UPLOAD_DIMENSION:G=this._config.errors.dimension;
break;
case z.UPLOAD_TIME:if(this._canUpload){this._canUpload=false;
J.failureType=z.TIME_RETRY;
this._track(u.events.UPLOAD_FAIL,J);
this._refreshHashInfo().then(function(){F._$uploadForm.trigger(l.SUBMIT)
});
return
}break
}this._canUpload=true;
this._track(u.events.UPLOAD_FAIL,J);
this._showError(G);
this._resetUploadInput();
this._setState(this._lastState)
},_refreshHashInfo:function(){var F=this._$el.find('[name="upload_info"]');
return f.get(this._config.dataUrl).then(function(G){F.val(G.content.TopcardBackground.hashInfoJS)
})
},_onUploadSuccess:function(I,J){var H=this._getMediaUrl(J.value),F=this._getUploadedFileName(),G=this;
this._canUpload=true;
this._resetUploadInput();
this._mediaId=J.value;
if(J.sig){this._mediaIdSignature=J.sig
}this._preloadImage(H).then(function(K){G._config.isCustomUpload=true;
G._setScalingDimension(K);
G.setImage({url:H});
G.setPosition({offsetY:0});
G._setState(s.EDIT);
G._checkImageSize(K);
G._enableChangeBgUploader();
G._track(u.events.UPLOAD_SUCCESS,{returnedFilename:encodeURIComponent(H),uploadedFilename:F})
})
},_onBackgroundMouseDown:function(G){var H=this._$el.position().top,F=this._$el.outerHeight(true),I=G.pageY>=H&&G.pageY<=H+F;
if(this._state===s.EDIT&&I){if(!this._maxOffset){this._setMaxOffset()
}this._$doc.one(l.MOUSEUP,this._onBackgroundMouseUp).on(l.MOUSEMOVE,this._onBackgroundMouseMove);
this._currentTracker=this._createMouseTracker(G.pageY,this._currentImage.offsetY||0);
G.preventDefault();
return false
}},_onBackgroundMouseUp:function(F){this._$doc.off(l.MOUSEMOVE,this._onBackgroundMouseMove)
},_onBackgroundMouseMove:function(F){F.preventDefault();
this.setPosition({offsetY:this._currentTracker(F.pageY)})
},_onUploadMouseMove:function(F){var I=this._$uploadInput,G=this._$header,H=0;
if(this._$textAd.length){G=this._$textAd
}else{if(this._$responsiveNav.length){G=this._$responsiveNav
}}H=G.offset().top+G.outerHeight(true);
if(F.pageY<H||this._intersectRect(F.pageX,F.pageY,this._$profile)){return
}this._handleCallout(F);
I.offset({left:(F.pageX-I.width()/2),top:(F.pageY-I.height()/2)})
},_onWindowScroll:function(){var G,F=this._$el[0].getBoundingClientRect();
if(F.top+F.height>0){G=this._$win.scrollTop()/2;
this._$image.css({"transform":"translateY("+G+"px)","-moz-transform":"translateY("+G+"px)","-webkit-transform":"translateY("+G+"px)"})
}},_onProfileEdit:function(){if(this._config.showUploader){if(!this._config.isCustomUpload){this._setState(s.UPLOAD);
this._enableAddBgUploader();
this._track(u.events.BG_IMPRESSION)
}else{this._setState(s.EDIT_IMAGE);
this._disableBgUploader()
}this._$body.removeClass(y+"-view").addClass(y)
}},_onProfileView:function(){this._disableBgUploader();
if(!this._config.isCustomUpload&&!this._config.uploadOnView){this._$body.removeClass(y);
this._setState(s.VIEW)
}else{if(!this._config.isCustomUpload&&this._config.uploadOnView){this._setState(s.UPLOAD);
this._enableAddBgUploader()
}else{this._$body.addClass(y+"-view")
}}},_setState:function(F){this._lastState=this._state;
this._state=F;
this._$el.attr("class","");
this._$el.addClass(y+"-state-"+F);
if(F===s.EDIT){this._$hiddenOnEditElements.hide()
}else{this._$hiddenOnEditElements.show()
}},_createMouseTracker:function(F,G){return function(H){return G+H-F
}
},_getMediaUrl:function(F){return F.indexOf("http")===0?F:this._config.mediaRoot.replace("mediaId",F)
},_track:function(F,H){H=H||{};
H.locale=this._content.locale||"na";
var G=this._isInEditMode()?u.prefixEdit:u.prefixView;
WebTracking.trackUserAction(G+F,H)
},_isInEditMode:function(){return this._$wrap.hasClass(B)
},_enableChangeBgUploader:function(){var H=this._$changeArea,F=H.offset(),G=this._$el.offset().top;
this._$doc.off(l.MOUSEMOVE);
this._$uploadInput.removeClass(C.UPLOADER_HOVER).addClass(C.UPLOADER_DISABLED)
},_enableAddBgUploader:function(){this._initCallout();
this._$uploadInput.removeClass(C.UPLOADER_DISABLED).addClass(C.UPLOADER_HOVER);
this._$doc.on(l.MOUSEMOVE,this._onUploadMouseMove)
},_disableBgUploader:function(){this._$doc.off(l.MOUSEMOVE);
this._$uploadInput.removeClass(C.UPLOADER_HOVER).addClass(C.UPLOADER_DISABLED)
},_resetUploadInput:function(){this._$uploadInput.replaceWith(this._$uploadClone.clone());
this._$uploadInput=this._$el.find(C.UPLOADER_INPUT)
},_intersectRect:function(G,I,H){if(!H){return false
}var F=H.offset();
return G>=F.left&&G<=F.left+H.outerWidth(true)&&I>=F.top&&I<=F.top+H.outerHeight(true)
},_initCallout:function(){if(!this._$info){this._$info=this._$el.find(".info");
this._callout=new h(this._$info.get(0),{id:this._$info.data("li-tooltip-id"),orientation:"top",width:"auto",type:"hovercard-callout"})
}},_handleCallout:function(F){var G=this._intersectRect(F.pageX,F.pageY,this._$info);
if(!this._calloutEngaged&&G){this._calloutEngaged=true;
this._callout.open();
this._track(u.events.INFO_BUBBLE)
}else{if(!G&&this._calloutEngaged){this._calloutEngaged=false;
this._callout.close()
}}},_displayUploadOnView:function(){return this._config.uploadOnView&&!this._config.isCustomUpload
},_getUploadedFileName:function(){var G=this._$uploadInput.val(),F=G.split(/(\\|\/)/g);
return F?encodeURIComponent(F.pop()):null
}}
});
g.EVENTS_API=b;
LIModules.exports("FreemiumBg",g)
}(window.require));(function(){dust.register("tl/shared/inputs/inputFileImage",c);
function c(e,d){return e.write('<input type="file" accept="image/jpeg, image/jpg, image/png, image/gif" name="').reference(d.get(["name"],false),d,"h").write('"').exists(d.get(["className"],false),d,{"block":b},null).exists(d.get(["id"],false),d,{"block":a},null).write("/>")
}function b(e,d){return e.write('class="').reference(d.get(["className"],false),d,"h").write('"')
}function a(e,d){return e.write('id="').reference(d.get(["id"],false),d,"h").write('"')
}return c
})();
(function(){dust.register("inputFileImage",dust.cache["tl/shared/inputs/inputFileImage"])
})();(function(){dust.register("tl/apps/profile/v2/embed/freemium_profile",d);
function d(f,e){return f.write('<div id="freemium-bg">').exists(e.get(["selfView"],false),e,{"block":c},null).write('<div class="freemium-bg-images"><img class="freemium-bg-image" src="" alt="image"/></div>').exists(e.get(["selfView"],false),e,{"block":a},null).write("</div>")
}function c(f,e){return f.write('<form class="freemium-bg-upload-form" action="').reference(e.get(["link_media_upload"],false),e,"h").write('" method="POST" enctype="multipart/form-data">').partial("tl/shared/inputs/inputFileImage",e,{"name":"file","className":"freemium-bg-upload-input","id":"backgroundImageFile"}).write('<input type="hidden" name="upload_info" value="').reference(e.get(["hashInfoJS"],false),e,"h").write('"/><input type="hidden" name="persist" value="true"/><input type="hidden" name="csrfToken" value="').reference(e.get(["csrfToken"],false),e,"h").write('"/>').helper("eq",e,{"block":b},{"key":e.get(["lix_sign_response_enabled"],false),"value":"enabled"}).write("</form>")
}function b(f,e){return f.write('<input type="hidden" name="sign_response" value="true" />')
}function a(f,e){return f.write('<div class="freemium-bg-controls"><div class="freemium-bg-controls-edit"><button class="freemium-bg-cancel-button" title="').reference(e.get(["i18n_cancel"],false),e,"h").write('" type="button"></button><button class="remove-image" type="button">').reference(e.get(["i18n_remove"],false),e,"h").write('</button><label class="freemium-bg-change-button" for="backgroundImageFile">').reference(e.get(["i18n_change"],false),e,"h").write('</label><button class="freemium-bg-save-button" type="button">').reference(e.get(["i18n_save"],false),e,"h").write('</button></div><div class="freemium-bg-drag-prompt">').reference(e.get(["i18n_drag_to_position"],false),e,"h").write('</div><div class="freemium-bg-upload-button"><p class="freemium-bg-upload-button-text"><strong>').reference(e.get(["i18n_add_background"],false),e,"h").write("</strong>").reference(e.get(["i18n_add_suggestion"],false),e,"h").write('<span class="help">').reference(e.get(["i18n_recommended_size"],false),e,"h").write(' <i class="info" data-li-tooltip-id="freemium-image-specs"></i></span><div id="freemium-image-specs" class="callout-container"><div class="callout-content"><div class="callout-body"><p>').reference(e.get(["i18n_image_specs"],false),e,"h").write('</p></div></div></div></p></div><button class="freemium-bg-edit-button" type="button">').reference(e.get(["i18n_edit_background"],false),e,"h").write('</button></div><div class="freemium-bg-spinner"></div>')
}return d
})();
(function(){dust.register("freemium_profile",dust.cache["tl/apps/profile/v2/embed/freemium_profile"])
})();!function(a){function b(){this.nodes={},this.requests={},n.addListener(a,i,n.bind(this.receiveMessage,this))}function c(b){var c,e=n.getQueryParams();b=b||{},c=b.remote,this.channel=b.channel||e[l]||"e_"+(new Date).getTime(),this.container=c?new d(this.channel,c,b.container):null,c||(this.remoteWindow=a.parent),this.remoteOrigin=this._getRemoteOrigin(c)||e[k],this.methods=b.methods||{},this.methods[j]=this._buildReady(b.ready),this.container||this._sendDiscovery()}function d(b,c,d){var e=a.document,f=this.el=e.createElement("iframe");c&&c.match(m)&&(f.name=f.id=b,f.src=this.buildFrameSrc(c),d?this.setAttributes(d):(this.setDefaults(),e.getElementsByTagName("body")[0].appendChild(f)))}function e(a,b,c){var d={method:a};b&&(d.params=b),c||(this.id=d.id=this._generateId()),this.payload=d}function f(a){function c(b){function c(a){return function(){var b=g.addRequest(a,[].slice.call(arguments));return d.send(b.payload),b}}for(var f=b.length;f--;)e[b[f]]=c(b[f]);a.methods&&d.container&&d._sendDiscovery()}var d,e=this,f=a.ready;g||(g=new b),f?a.ready=function(a){c(a),f()}:a.ready=c,d=g.addNode(a),this.$destroy=function(){g.removeNode(d)},this.$container=function(){return d.container&&d.container.el},this.VERSION="0.3.1"}var g,h="2.0",i="message",j="rpc.discover",k="e_origin",l="e_channel",m=/^https?:\/\//,n={bind:function(a,b){return function(){a.apply(b,arguments)}},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},getQueryParams:function(){function b(a){return a.replace(/[\x00'"<\\]/g,"ï¿½")}for(var c,d,e=a.location.search.slice(1).split("&"),f={};e.length;)d=e.pop(),d&&(c=d.split("="),c.length>1&&(f[decodeURIComponent(c[0])]=b(decodeURIComponent(c[1]))));return f}};a.addEventListener?n.addListener=function(a,b,c){a.addEventListener(b,c,!1)}:a.attachEvent&&(n.addListener=function(a,b,c){a.attachEvent("on"+b,c)}),b.prototype={addNode:function(a){var b=new c(a);return this.nodes[b.channel]=b,b},addRequest:function(a,b){var c=new e(a,b);return this.requests[c.id]=c,c},removeNode:function(a){delete this.nodes[a.channel],a.destroy()},_parseJSONMessage:function(a){try{return JSON.parse(a)}catch(b){return null}},receiveMessage:function(a){var b,c;b=this._parseJSONMessage(a.data),b&&(c=this.nodes[b.channel],c&&a.origin===c.remoteOrigin&&(b.method?this.processMessage(c,b):(this.requests[b.id].process(b),delete this.requests[b.id])))},processMessage:function(a,b){var c,d=a.methods[b.method],e=a.buildCallback(this._buildResultPayload,b.id),f=a.buildCallback(this._buildErrorPayload,b.id),g=b.params;g=n.isArray(g)?g:[g],c=d.apply(a,g.concat(e,f)),c&&e(c)},_buildResultPayload:function(a,b){return{result:a,id:b}},_buildErrorPayload:function(a,b){return{error:{code:-32099,message:a},id:b}}},c.prototype={send:function(b){var c=this;b.jsonrpc=h,b.channel=c.channel,a.setTimeout(function(){c.remoteWindow.postMessage(JSON.stringify(b),c.remoteOrigin)},10)},destroy:function(){this.container&&(this.container.destroy(),this.container=null)},buildCallback:function(a,b){var c=this;return function(){c.send(a(arguments[0],b))}},_buildReady:function(a){var b=this;return function(){var c=b.container,d=c&&c.el;return b.remoteWindow||!c||(b.remoteWindow=d.contentWindow,b.remoteWindow)?void a.apply(b,arguments):void n.addListener(d,"load",function(){b.remoteWindow=d.contentWindow,a.apply(b,arguments)})}},_sendDiscovery:function(){var a=new e(j,[this._getMethodNames()],!0);this.send(a.payload)},_getMethodNames:function(){var a,b=this.methods,c=[];for(a in b)c.push(a);return c},_getRemoteOrigin:function(a){var b;return a&&"string"==typeof a?(b=a.split("/"),b[0]+"//"+b[2]):""}},d.prototype={destroy:function(){var a=this.el;a&&a.parentNode&&a.parentNode.removeChild(a),this.el=null},setAttributes:function(a){var b,c=this.el;for(b in a)"style"===b?c.style.cssText=a[b]:c[b]=a[b]},setDefaults:function(){var a=this.el.style;a.visibility="hidden",a.width="1px",a.height="1px",a.position="absolute",a.left="-999px",a.top="0"},buildFrameSrc:function(b){var c=a.location,d=c.origin?c.origin:c.protocol+"//"+c.host,e=k+"="+d,f=b.split("#"),g=f[0].split("?");return b=(g[1]?g.join("?")+"&":g[0]+"?")+e,b+="&"+l+"="+this.el.id,f[1]&&(b+="#"+f[1]),b}},e.prototype={process:function(a){a.result&&this._resultCallback?this._resultCallback(a.result):a.error&&this._errorCallback&&this._errorCallback(a.error)},result:function(a){return this._resultCallback=a,this},error:function(a){return this._errorCallback=a,this},_generateId:function(){var a=0;return function(){return++a}}()},a.Espany=f}(window);